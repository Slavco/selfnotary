<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<title>Self Notary</title>
		<link href="bootstrap.min.css" rel="stylesheet">
		<style>
			.file-area {
				display: block;
				padding: 10px;
				border: 1px solid #ccc;
			}
			
			#drop_zone {
				border: 2px dashed #bbb;
				-moz-border-radius: 5px;
				-webkit-border-radius: 5px;
				border-radius: 5px;
				padding: 20px;
				text-align: center;
			}
			
			#file {
				display: block;
				width: 0;
				height: 0;
			}
			
			#list {
				overflow: hidden;
				text-overflow: ellipsis;	
			}
			
			.progress-bar {
 				-webkit-transition: width .0s ease;
       			-o-transition: width .0s ease;
          		transition: width .0s ease;
			}
			
			.progress-bar[aria-valuenow="1"], .progress-bar[aria-valuenow="2"], .progress-bar[aria-valuenow="0"] {
  				min-width: 0px;
			}
		</style>
	</head>
	<body>
		<div class="container" id="main-wrapper">
			<div class="row">
				<div class="col-sm-10 col-sm-offset-1" id="header">
					<div class="page-header">
						<h1 class="text-center">Self Notary<br><small>Use blockchain to prove that you own digital good from certain time</small></h1>
					</div>
				</div>
			</div>
			<div class="row">
				<div class="col-sm-8 col-sm-offset-2" id="footer">
					<p class="text-nowrap">
						<h3>Why?</h3>
						Because this way we don't need any third party to take place during process of using blockchain as notary service.	
					</p>
				</div>
			</div>
			
			<div class="row">
				<div class="col-sm-8 col-sm-offset-2" id="footer">
					<p class="text-nowrap">
						<h3>How it works</h3>
						<ol>
							<li>Everything works localy / no internet is needed e.g. no server side code or communication.</li>
							<li>Using file contents we generate valid public address corresponding to the choosen blockchain. <strong>Funds sent to this address could not be spent!</strong></li>
							<li>User now can send minimum amount of 1 satoshi from choosen currency to the generated address from his wallet + transaction fee required by the network.</li>
							<li>When transaction is confirmed by the network then we have a proof that this document was under user possesion during the transaction time. Always content of this document UTF-8 encoded will give the same hash and the same public address.</li>
							<li>User can prove that he is the owner of the sender address by signing any message using his private key.</li>
							<li>This way you can prove that you poses some document from certain time and you can prove your identity e.g. show to everyone that you are the real owner.</li>
							<li>Always keep backup of the verified document and sender wallet / private key</li>
						</ol>	
					</p>
				</div>
			</div>
			<div class="row">
				<div class="col-sm-8 col-sm-offset-2" id="footer">
					<p class="text-nowrap">
						<h3>How to use</h3>
						<ol>
							<li>Choose blockchain.</li>
							<li>Select your document.</li>
							<li>Send 1 satoshi to the generated address.</li>
							<li>Make sure you have wallet and document backup.</li>
							<li>No need to remember the address or transaction keys because you can always recreate public key using the document and find the transaction using any block explorer.</li>
						</ol>	
					</p>
				</div>
			</div>
			<div class="row">
				<div class="col-sm-8 col-sm-offset-2" id="content">
					<form class="form" id="main-form" for="form" method="post">
						<div class="form-group">
							<br>
							<label for="blockchain">Blockchain</label>
							<select class="form-control" id="blockchain">
								<option value="0x0E">Fethercoin</option>
								<option value="0x47">Vertcoin</option>
								<option value="0x1E">Dogecoin</option>
								<option value="0x30">Litecoin</option>
								<option value="0x00">Bitcoin</option>
							</select>
						</div>
						<div class="form-group">
							<br>
							<div class="file-area">
								<div id="drop_zone">
									<span class="text-muted lead">Drag and drop file here</span>
								</div>
								<input type="file" id="file" />
								<output id="list"></output>
							</div>						
							<br>
							<div class="progress">
								<div class="progress-bar progress-bar-striped active" id="progressbar" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div> 
							</div>
						</div>
						
						<div class="form-group should-hide">
							<br>
							<table class="table table-condensed table-bordered" id="info">
								<tr class="active">
									<td class="text-center"><strong>Document hash</strong></td>
									<td id="documenthash"></td>
								</tr>
								<tr class="active">
									<td class="text-center"><strong>Notary address</strong></td>
									<td id="notaryaddress"></td>
								</tr>
							</table>
						</div>
						<div class="form-group should-hide text-center">
							<div class="img-thumbnail" id="qrcode">
						</div>
					</form>
				</div>
			</div>
			<div class="row">
				<div class="col-sm-8 col-sm-offset-2" id="footer">
					<h3>Open Source</h3>
					View page source or <a href="https://github.com/Slavco/selfnotary">https://github.com/Slavco/selfnotary</a>
				</div>
			</div>
			<div class="row">
				<div class="col-sm-8 col-sm-offset-2" id="footer">
						<h3>Support this project</h3>
						<ul>
						<li>BTC:  1LuckAsHuFJ3Y59aztSxzHaBtRihc2vDmX</li>
						<li>FTC:  6sLaveXfN6Nhi96LVufa4GjrojGnXsbc4w</li>
						<li>VTC:  VpzZ7DnyoznqZxFjKqsJEVkSn74AiczX7a</li>
					    <li>DOGE:  DCze9pB2xcUWkKPYQ7BW6Lu8gaF5eqzk9o</li>
						</ul>
					
				</div>
			</div>
			<div class="row">
				<div class="col-sm-10 col-sm-offset-1" id="footer">
					<br><br><br>
					<p class="text-nowrap text-center"><small>Copyright &copy; 2014</small></p>
				</div>
			</div>
		</div>
		<script src="bitcoinjs-min.js"></script>
		<script src="qrcode.js"></script>
		<script src="jquery.js"></script>
		<script src="bootstrap/js/bootstrap.min.js"></script>
		<script>
			var block = parseInt($('#blockchain').val());
			var hasFile = false;
			var fileContent = "";
			var qrcode = new QRCode("qrcode");
			
			
			$('.should-hide').hide();
			$('#blockchain').on('change', function() {
				block = parseInt($('#blockchain').val());
				if ( hasFile ){
					doNotary(block, fileContent);
				}
			});
			$('#drop_zone').on('click', function(evt) {
				$('#file').trigger('click');
			});

			// Check for the various File API support.
			if (window.File && window.FileReader && window.FileList && window.Blob) {
				// Great success! All the File APIs are supported.
    			var reader;
				var progress = document.getElementById('progressbar');

				// Setup the dnd listeners.
				var dropZone = document.getElementById('drop_zone');
				dropZone.addEventListener('dragover', handleDragOver, false);
				dropZone.addEventListener('drop', function(evt) {
					var fileList = evt.dataTransfer.files; // FileList object.
					handleFileSelect(evt, fileList);
				}, false);	

				var fileSelect = document.getElementById('file');
				fileSelect.addEventListener('click', function() {
				    this.value = '';
				});
				fileSelect.addEventListener('change', function(evt) {
					var fileList = evt.target.files; // FileList object.
					handleFileSelect(evt, fileList); 
				}, false);

				function handleDragOver(evt) {
					evt.stopPropagation();
				    evt.preventDefault();
				    evt.dataTransfer.dropEffect = 'copy'; // Explicitly show this is a copy.
				}

				function handleFileSelect(evt, fileList) {
					evt.stopPropagation();
					evt.preventDefault();

					$('.should-hide').hide();
					$('#go-btn').attr('disabled', 'disabled');

					var files = fileList; // FileList object.
					var output = [];

					output.push = output.push('<strong>', escape(files[0].name), '</strong> (', files[0].type || 'n/a', ') - ',
			                  					files[0].size, ' bytes, last modified: ', 
			                  					files[0].lastModifiedDate ? files[0].lastModifiedDate.toLocaleDateString() : 'n/a'
				                  			);
				
					// Reset progress indicator on new file selection.
	    			progress.style.width = '0%';
	    			progress.setAttribute('aria-valuenow', 0);
	    			progress.innerText = '0%';
	    			
					reader = new FileReader();
					reader.onerror = errorHandler;
					reader.onprogress = updateProgress;
					//reader.onabort = function(evt)
					//reader.onloadstart = function(evt)
					reader.onload = function(evt) {
						progress.style.width = '100%';
		    			progress.setAttribute('aria-valuenow', 100);
		    			progress.innerText = '100%';
					}
					reader.onloadend = function(evt) {
						hasFile = true;
						fileContent = evt.target.result;
						doNotary(block, fileContent);
					}

					document.getElementById('list').innerHTML = output.join('');
					
					// Read in the file as a binary string.
				    reader.readAsBinaryString(files[0]);
				}
				
				function doNotary(b, c){
					var hash = Bitcoin.Util.sha256ripe160(c);
			      	var addr = new Bitcoin.Address(hash);
					addr.version = parseInt(b);
					$("#notaryaddress").html(addr.toString());
					$("#documenthash").html(Crypto.SHA256(c));
					qrcode.clear();
					qrcode.makeCode(addr.toString());
					setTimeout("$('.should-hide').fadeIn();", 200);					
				}
				
				function errorHandler(evt) {
					hasFile = false;
					switch(evt.target.error.code) {
				    	case evt.target.error.NOT_FOUND_ERR:
				        	console.log('File Not Found!');
				        	break;
				      	case evt.target.error.NOT_READABLE_ERR:
				        	console.log('File is not readable');
				        	break;
				      	case evt.target.error.ABORT_ERR:
				        	break; // noop
				      	default:
				        	console.log('An error occurred reading this file.');
				    };
				}

				function updateProgress(evt) {
					// evt is an ProgressEvent.
				    if (evt.lengthComputable) {
				      	var percentLoaded = Math.round((evt.loaded / evt.total) * 100);
				      	// Increase the progress bar length.
				      	if (percentLoaded < 100) {
				        	progress.style.width = percentLoaded + '%';
				        	progress.setAttribute('aria-valuenow', percentLoaded);
				        	progress.innerText = percentLoaded + '%';
				      	}
				    }
				}
			} else {
			  	console.log('The File APIs are not fully supported in this browser.');
			}
		</script>
	</body>
</html>